---
alwaysApply: true
---

# üìã Reglas de Gherkin y Cucumber - Paynova Automation

## üéØ Estructura de Archivos

```
src/
‚îú‚îÄ‚îÄ features/
‚îÇ   ‚îú‚îÄ‚îÄ vida/              # Features del √°rea VIDA
‚îÇ   ‚îî‚îÄ‚îÄ siniestros/        # Features del √°rea SINIESTROS
‚îú‚îÄ‚îÄ step-definitions/
‚îÇ   ‚îú‚îÄ‚îÄ vida/              # Step definitions de VIDA
‚îÇ   ‚îî‚îÄ‚îÄ siniestros/        # Step definitions de SINIESTROS
‚îî‚îÄ‚îÄ pages/                 # Page Object Model (POM)
    ‚îú‚îÄ‚îÄ LoginPage.ts
    ‚îú‚îÄ‚îÄ RegistrarSolicitudPage.ts
    ‚îî‚îÄ‚îÄ ...
```

**Reglas**: `.feature` y `.steps.ts` en la misma estructura de carpetas. Page Objects en `src/pages/` compartidos entre √°reas.

---

## üìù Feature Files (.feature)

### Estructura B√°sica
```gherkin
# language: es
Caracter√≠stica: [Nombre descriptivo]
  Como [rol]
  Quiero [acci√≥n]
  Para [beneficio]

Antecedentes:
  Dado que estoy autenticado como usuario "vida"
  Y estoy en la p√°gina de Registrar Solicitud de Pago

@registrar-vida @happy-path @suite-vida
Escenario: VIDA - Pago Sobrevivencia Interbank D√≥lares
  Cuando selecciono el memo "PAGO DE SOBREVIVENCIA"
  Y hago clic en ENVIAR
  Y completo los datos de VIDA desde JSON "pago_sobrevivencia_interbank_dolares"
  Entonces deber√≠a ver el registro guardado
```

### Tags Principales
- **Tipo**: `@happy-path`, `@unhappy-path`, `@regresion`, `@validacion-campos`
- **√Årea**: `@registrar-vida`, `@registrar-siniestros`, `@login`
- **Suite**: `@suite-vida`, `@suite-siniestros`, `@suite-completa`
- **Aprobaci√≥n**: `@rechazar`, `@observar`, `@aprobador2`, `@aprobador3`

### Steps
- **Given**: `Dado que estoy...` (estado inicial)
- **When**: `Cuando...`, `Y...` (acciones)
- **Then**: `Entonces deber√≠a...` (verificaciones)

### Datos
- **JSON** (preferido): `Y completo los datos de VIDA desde JSON "identificador"`
- **Tablas**: Para datos espec√≠ficos del escenario

---

## üèóÔ∏è Page Object Model (POM) - OBLIGATORIO

### Estructura B√°sica
```typescript
import { Page } from 'playwright';

export class LoginPage {
  private page: Page;
  
  // ‚úÖ Selectores PRIVADOS en objeto
  private readonly selectors = {
    usernameInput: 'input[placeholder="Usuario"]',
    passwordInput: 'input[type="password"]',
    loginButton: 'button[type="submit"]'
  };

  constructor(page: Page) {
    this.page = page;
  }

  // ‚úÖ M√©todos p√∫blicos descriptivos
  async enterUsername(username: string): Promise<void> {
    await this.page.fill(this.selectors.usernameInput, username);
    console.log(`‚úì Usuario ingresado: ${username}`);
  }

  async isLoginSuccessful(): Promise<boolean> {
    try {
      await this.page.waitForSelector('.navbar', { timeout: 10000 });
      return true;
    } catch {
      return false;
    }
  }
}
```

### Reglas Cr√≠ticas del POM

#### ‚úÖ OBLIGATORIO
1. **Selectores privados**: Todos en objeto `selectors` privado
2. **M√©todos p√∫blicos**: Acciones y verificaciones como m√©todos p√∫blicos
3. **Documentaci√≥n**: JSDoc en m√©todos p√∫blicos
4. **Timeouts**: Definir como constantes, usar esperas expl√≠citas
5. **Constructor**: Recibir `Page` de Playwright

#### ‚ùå PROHIBIDO
1. **Selectores en steps**: NUNCA `page.click('selector')` en step definitions
2. **Selectores p√∫blicos**: NUNCA exponer selectores
3. **Assertions en POM**: NUNCA `expect()` en Page Objects
4. **L√≥gica de UI en steps**: NUNCA interacci√≥n directa con `page` en steps

### Uso en Step Definitions
```typescript
import { When, Then } from '@cucumber/cucumber';
import { expect } from '@playwright/test';
import { LoginPage } from '../../pages/LoginPage';

When('ingreso el usuario {string}', async function(username: string) {
  const loginPage = new LoginPage(global.page);  // ‚úÖ Instanciar
  await loginPage.enterUsername(username);        // ‚úÖ Usar m√©todo POM
  console.log(`‚úì Usuario ingresado: ${username}`);
});

Then('deber√≠a ver el dashboard', async function() {
  const loginPage = new LoginPage(global.page);
  const isSuccess = await loginPage.isLoginSuccessful();  // ‚úÖ Verificaci√≥n en POM
  expect(isSuccess).toBeTruthy();                        // ‚úÖ Assertion en step
});
```

### Convenciones de M√©todos
- **Navegaci√≥n**: `navigateTo[Nombre]()`, `abrir[Nombre]()`
- **Acciones**: `click[Nombre]()`, `seleccionar[Nombre]()`, `ingresar[Nombre]()`
- **Verificaciones**: `is[Nombre]()`, `verificar[Nombre]()` ‚Üí retornan `boolean`

### Timeouts
```typescript
const timeouts = {
  short: 5000,
  medium: 10000,
  long: 30000
};

// ‚úÖ Correcto: Espera expl√≠cita
await this.page.waitForSelector(this.selectors.btnGuardar, {
  state: 'visible',
  timeout: timeouts.medium
});

// ‚ùå Incorrecto: Espera fija
await this.page.waitForTimeout(5000);
```

---

## üîß Step Definitions (.steps.ts)

### Estructura
```typescript
import { Given, When, Then } from '@cucumber/cucumber';
import { expect } from '@playwright/test';
import { [PageObject] } from '../../pages/[PageObject]';

// ==================== GIVEN ====================
Given('que estoy autenticado como usuario {string}', async function(nombre: string) {
  const loginPage = new LoginPage(global.page);
  // ... implementaci√≥n usando POM
});

// ==================== WHEN ====================
When('selecciono el memo {string}', async function(memo: string) {
  const registrarPage = new RegistrarSolicitudPage(global.page);
  await registrarPage.seleccionarMemo(memo);
});

// ==================== THEN ====================
Then('deber√≠a ver el registro guardado', async function() {
  const registrarPage = new RegistrarSolicitudPage(global.page);
  const isVisible = await registrarPage.verRegistroEnGrilla();
  expect(isVisible).toBeTruthy();
});
```

### Reglas
- ‚úÖ **SIEMPRE** usar Page Objects
- ‚úÖ Agrupar por tipo (Given/When/Then) con comentarios
- ‚úÖ Instanciar Page Object en cada step pasando `global.page`
- ‚úÖ Hacer assertions con `expect` en steps, no en POM
- ‚ùå **NUNCA** l√≥gica de UI directa (`page.click()`, `page.fill()`)

---

## ‚úÖ Buenas Pr√°cticas

### Gherkin
- ‚úÖ Lenguaje natural y claro
- ‚úÖ Escenarios descriptivos: `[√ÅREA] - [Descripci√≥n]`
- ‚úÖ Tags consistentes (√°rea + tipo + suite)
- ‚úÖ Preferir JSON para datos complejos
- ‚úÖ Comentarios para agrupar escenarios

### Page Objects
- ‚úÖ Un Page Object por p√°gina principal
- ‚úÖ M√©todos peque√±os y enfocados
- ‚úÖ Reutilizar m√©todos entre steps
- ‚úÖ Documentar con JSDoc
- ‚úÖ Usar esperas expl√≠citas

### Step Definitions
- ‚úÖ Steps reutilizables
- ‚úÖ Orquestar llamadas a POM
- ‚úÖ Assertions claras y espec√≠ficas

---

## üö´ Errores Comunes

1. ‚ùå Selectores en step definitions ‚Üí Usar Page Objects
2. ‚ùå `page.click()` directo en steps ‚Üí M√©todos de POM
3. ‚ùå Selectores p√∫blicos en POM ‚Üí Privados en objeto `selectors`
4. ‚ùå `expect()` en Page Objects ‚Üí Solo en steps
5. ‚ùå `waitForTimeout()` ‚Üí Usar `waitForSelector()`
6. ‚ùå Datos hardcodeados ‚Üí JSON o tablas
7. ‚ùå Steps duplicados ‚Üí Reutilizar steps existentes
8. ‚ùå Tags faltantes ‚Üí Incluir √°rea + tipo + suite

---

## üîç Resoluci√≥n de Problemas y Debugging

### Uso Autom√°tico de MCP (Model Context Protocol)

**REGLA CR√çTICA**: Cuando ocurra alguno de los siguientes casos, **SIEMPRE** usar MCP autom√°ticamente para investigar y resolver:

1. **Errores durante la ejecuci√≥n**:
   - Errores de compilaci√≥n o linting
   - Errores en tiempo de ejecuci√≥n de tests
   - Timeouts o elementos no encontrados
   - Assertions fallidas

2. **Falta de comprensi√≥n**:
   - No se entiende la estructura de una p√°gina
   - Selectores no funcionan como se espera
   - Comportamiento inesperado de la aplicaci√≥n
   - Dudas sobre la implementaci√≥n correcta

3. **Proceso de debugging**:
   ```
   1. Abrir MCP autom√°ticamente (usar herramientas de Playwright MCP)
   2. Navegar a la URL de la aplicaci√≥n si es necesario
   3. Tomar screenshot del estado actual
   4. Inspeccionar elementos problem√°ticos usando selectores
   5. Revisar console logs para errores JavaScript
   6. Verificar HTML de la p√°gina si es necesario
   7. Seguir los steps manualmente para reproducir el problema
   8. Identificar la causa ra√≠z
   9. Aplicar la soluci√≥n correspondiente
   ```

### Herramientas MCP Disponibles

- **Navegaci√≥n**: `mcp_playwright_playwright_navigate` - Abrir la aplicaci√≥n
- **Screenshots**: `mcp_playwright_playwright_screenshot` - Capturar estado visual
- **Interacci√≥n**: `mcp_playwright_playwright_click`, `mcp_playwright_playwright_fill` - Probar interacciones
- **Inspecci√≥n**: `mcp_playwright_playwright_get_visible_html` - Ver estructura HTML
- **Console Logs**: `mcp_playwright_playwright_console_logs` - Revisar errores JavaScript
- **Evaluaci√≥n**: `mcp_playwright_playwright_evaluate` - Ejecutar JavaScript para debugging

### Ejemplo de Flujo de Debugging

```typescript
// Cuando hay un error:
// 1. Abrir MCP y navegar
await mcp_playwright_playwright_navigate({ url: 'https://app-url.com' });

// 2. Tomar screenshot del estado actual
await mcp_playwright_playwright_screenshot({ name: 'error-state' });

// 3. Revisar console logs
await mcp_playwright_playwright_console_logs({ type: 'error' });

// 4. Inspeccionar HTML del elemento problem√°tico
await mcp_playwright_playwright_get_visible_html({ selector: '#elemento-problema' });

// 5. Probar interacci√≥n manualmente
await mcp_playwright_playwright_click({ selector: '#boton' });

// 6. Identificar y corregir el problema
```

**IMPORTANTE**: No asumir el problema sin verificar visualmente con MCP. Siempre usar herramientas de debugging antes de hacer cambios en el c√≥digo.

---

## üîÑ Checklist

### Feature
- [ ] Carpeta correcta (`vida/` o `siniestros/`)
- [ ] `# language: es` en encabezado
- [ ] Antecedentes definidos
- [ ] Tags apropiados (√°rea + tipo + suite)
- [ ] Escenarios descriptivos

### Step Definitions
- [ ] Carpeta correspondiente
- [ ] **SIEMPRE** usar Page Objects
- [ ] Instanciar con `global.page`
- [ ] Assertions con `expect`

### Page Objects
- [ ] Selectores privados en objeto `selectors`
- [ ] M√©todos p√∫blicos documentados
- [ ] Timeouts como constantes
- [ ] Esperas expl√≠citas, no `waitForTimeout`
- [ ] Verificaciones retornan `boolean`

---

## üìö Referencias

- [Gherkin Syntax](https://cucumber.io/docs/gherkin/reference/)
- [Cucumber.js](https://github.com/cucumber/cucumber-js)
- [Playwright POM](https://playwright.dev/docs/pom)
